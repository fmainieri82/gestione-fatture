name: Build and Release

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Permette di eseguire manualmente il workflow

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Necessario per creare release e tag
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Cache npm dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build:prod
      
      - name: Copy frontend to backend static
        run: |
          mkdir -p backend/src/main/resources/static
          cp -r frontend/dist/frontend/browser/* backend/src/main/resources/static/
      
      - name: Build backend with Maven
        working-directory: ./backend
        run: mvn clean package -DskipTests
      
      - name: Get version from pom.xml
        id: get_version
        working-directory: ./backend
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Get commit message
        id: commit_info
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "commit_message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
      
      - name: Create distribution package
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          COMMIT_SHA="${{ steps.commit_info.outputs.commit_sha }}"
          PACKAGE_NAME="GestioneFatture-v${VERSION}"
          DIST_DIR="distribuzione/${PACKAGE_NAME}"
          
          # Crea directory di distribuzione
          mkdir -p "${DIST_DIR}"
          
          # Copia il JAR
          cp backend/target/fatture-backend-${VERSION}.jar "${DIST_DIR}/"
          
          # Crea script batch per Windows
          cat > "${DIST_DIR}/GestioneFatture.bat" << 'EOF'
          @echo off
          echo ========================================
          echo GESTIONE FATTURE
          echo ========================================
          echo.
          echo Avvio applicazione...
          echo.
          cd /d "%~dp0"
          
          REM Verifica Java
          where java >nul 2>&1
          if errorlevel 1 (
              echo ERRORE: Java non trovato!
              echo.
              echo Assicurati che Java 17 o superiore sia installato.
              echo Scarica Java da: https://adoptium.net/
              echo.
              pause
              exit /b 1
          )
          
          REM Crea cartelle necessarie
          if not exist "data" mkdir "data"
          if not exist "fatture" mkdir "fatture"
          if not exist "templates" mkdir "templates"
          if not exist "backups" mkdir "backups"
          
          REM Avvia l'applicazione
          start "" "java" -jar "fatture-backend-${VERSION}.jar"
          
          echo.
          echo Applicazione avviata!
          echo Il browser si aprir√† automaticamente su http://localhost:8080
          echo.
          echo Per chiudere l'applicazione, chiudi questa finestra.
          echo.
          timeout /t 3 >nul
          EOF
          
          # Sostituisci la variabile di versione nello script
          sed -i "s/\${VERSION}/${VERSION}/g" "${DIST_DIR}/GestioneFatture.bat"
          
          # Crea README per la distribuzione
          cat > "${DIST_DIR}/README.txt" << EOF
          ========================================
          GESTIONE FATTURE - v${VERSION}
          ========================================
          
          ISTRUZIONI DI INSTALLAZIONE E USO
          
          1. PREREQUISITI
             - Java 17 o superiore deve essere installato
             - Scarica Java da: https://adoptium.net/
             - Verifica installazione: java -version
          
          2. AVVIO RAPIDO
             - Doppio click su "GestioneFatture.bat"
             - Oppure esegui: java -jar fatture-backend-${VERSION}.jar
             - Il browser si aprir√† automaticamente su http://localhost:8080
          
          3. STRUTTURA CARTELLE
             - data/        : Database (creato automaticamente)
             - fatture/     : PDF generati
             - templates/   : Template personalizzati
             - backups/     : Backup database
          
          4. CONFIGURAZIONE
             - Modifica application.properties per personalizzare
             - I dati vengono salvati automaticamente nella cartella data/
          
          5. BACKUP
             - Per fare backup, copia la cartella "data/"
             - Per ripristinare, sostituisci la cartella "data/"
          
          6. PORTABILIT√Ä
             - Puoi copiare l'intera cartella su chiavetta USB
             - Funziona su qualsiasi PC Windows con Java installato
          
          ========================================
          Versione: ${VERSION}
          Commit: ${COMMIT_SHA}
          ========================================
          EOF
          
          # Crea script VBS per avvio senza console (opzionale)
          cat > "${DIST_DIR}/GestioneFatture.vbs" << 'EOF'
          Set WshShell = CreateObject("WScript.Shell")
          Set fso = CreateObject("Scripting.FileSystemObject")
          scriptPath = fso.GetParentFolderName(WScript.ScriptFullName)
          jarPath = scriptPath & "\fatture-backend-${VERSION}.jar"
          WshShell.Run "java -jar """ & jarPath & """", 0, False
          EOF
          
          sed -i "s/\${VERSION}/${VERSION}/g" "${DIST_DIR}/GestioneFatture.vbs"
          
          # Crea cartelle necessarie
          mkdir -p "${DIST_DIR}/data"
          mkdir -p "${DIST_DIR}/fatture"
          mkdir -p "${DIST_DIR}/templates"
          mkdir -p "${DIST_DIR}/backups"
          
          # Crea file .gitkeep per mantenere le cartelle
          touch "${DIST_DIR}/data/.gitkeep"
          touch "${DIST_DIR}/fatture/.gitkeep"
          touch "${DIST_DIR}/templates/.gitkeep"
          touch "${DIST_DIR}/backups/.gitkeep"
          
          # Crea il pacchetto ZIP
          cd distribuzione
          zip -r "${PACKAGE_NAME}.zip" "${PACKAGE_NAME}/"
          cd ..
          
          echo "PACKAGE_PATH=distribuzione/${PACKAGE_NAME}.zip" >> $GITHUB_ENV
          echo "Package created: distribuzione/${PACKAGE_NAME}.zip"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}-${{ steps.commit_info.outputs.commit_sha }}
          name: Release v${{ steps.get_version.outputs.version }} - ${{ steps.commit_info.outputs.commit_sha }}
          body: |
            ## üöÄ Release Automatica
            
            **Versione**: ${{ steps.get_version.outputs.version }}
            **Commit**: ${{ steps.commit_info.outputs.commit_sha }}
            **Data**: ${{ github.event.head_commit.timestamp }}
            
            ### üìù Modifiche
            ${{ steps.commit_info.outputs.commit_message }}
            
            ### üì¶ Artefatti
            - **Pacchetto di distribuzione completo** (ZIP) - Pronto all'uso!
            - JAR del backend compilato
            - Frontend compilato e integrato
            - Script di avvio per Windows
            - README con istruzioni
            
            ### üöÄ Come usare
            
            **Opzione 1 - Pacchetto completo (consigliato):**
            1. Scarica il file `GestioneFatture-v${{ steps.get_version.outputs.version }}.zip`
            2. Estrai il contenuto in una cartella
            3. Doppio click su `GestioneFatture.bat`
            4. Il browser si aprir√† automaticamente su http://localhost:8080
            
            **Opzione 2 - Solo JAR:**
            1. Scarica il file `fatture-backend-${{ steps.get_version.outputs.version }}.jar`
            2. Esegui con: `java -jar fatture-backend-${{ steps.get_version.outputs.version }}.jar`
            3. Apri il browser su: http://localhost:8080
            
            ### üìã Requisiti
            - Java 17 o superiore (scaricabile da https://adoptium.net/)
            - Windows (per il pacchetto completo)
          files: |
            distribuzione/GestioneFatture-v*.zip
            backend/target/fatture-backend-*.jar
          draft: false
          prerelease: false

