name: Build and Release

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Permette di eseguire manualmente il workflow

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write  # Necessario per creare release e tag
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Cache npm dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build:prod
      
      - name: Copy frontend to backend static
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path backend/src/main/resources/static | Out-Null
          Copy-Item -Path frontend/dist/frontend/browser/* -Destination backend/src/main/resources/static/ -Recurse -Force
      
      - name: Build backend with Maven
        working-directory: ./backend
        run: mvn clean package -DskipTests
      
      - name: Get version from pom.xml
        id: get_version
        working-directory: ./backend
        shell: pwsh
        run: |
          # Leggi direttamente dal pom.xml
          $pomContent = Get-Content pom.xml -Raw
          
          # Cerca la versione dopo l'artifactId fatture-backend (per evitare di prendere quella del parent)
          if ($pomContent -match '<artifactId>fatture-backend</artifactId>[\s\S]*?<version>([^<]+)</version>') {
              $version = $matches[1].Trim()
          } elseif ($pomContent -match '<groupId>com\.fatture</groupId>[\s\S]*?<artifactId>fatture-backend</artifactId>[\s\S]*?<version>([^<]+)</version>') {
              $version = $matches[1].Trim()
          } else {
              Write-Host "ERRORE: Versione non trovata nel pom.xml"
              Write-Host "Cercando pattern: <artifactId>fatture-backend</artifactId>...<version>X</version>"
              exit 1
          }
          
          Write-Host "Versione trovata: $version"
          echo "version=$version" >> $env:GITHUB_OUTPUT
      
      - name: Get commit message
        id: commit_info
        shell: pwsh
        run: |
          $commitMsg = git log -1 --pretty=%B
          $commitSha = git rev-parse --short HEAD
          Write-Host "commit_message<<EOF" >> $env:GITHUB_OUTPUT
          Write-Host $commitMsg >> $env:GITHUB_OUTPUT
          Write-Host "EOF" >> $env:GITHUB_OUTPUT
          Write-Host "commit_sha=$commitSha" >> $env:GITHUB_OUTPUT
      
      - name: Create Windows executable with jpackage
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          Write-Host "Versione ricevuta: '$version'"
          
          if ([string]::IsNullOrWhiteSpace($version)) {
              Write-Host "ERRORE: Versione vuota! Verifica lo step precedente."
              exit 1
          }
          
          $jarPath = "backend\target\fatture-backend-$version.jar"
          Write-Host "Creazione eseguibile Windows con jpackage..."
          Write-Host "JAR: $jarPath"
          
          # Verifica che il JAR esista
          if (-not (Test-Path $jarPath)) {
              Write-Host "ERRORE: JAR non trovato: $jarPath"
              exit 1
          }
          
          # Crea directory distribuzione
          $distDir = "distribuzione\jpackage-output"
          if (Test-Path $distDir) {
              Write-Host "Rimozione directory esistente..."
              Remove-Item -Path $distDir -Recurse -Force
          }
          New-Item -ItemType Directory -Force -Path $distDir | Out-Null
          
          # Esegui jpackage
          $inputDir = "backend\target"
          jpackage `
              --input $inputDir `
              --name "GestioneFatture" `
              --main-jar "fatture-backend-$version.jar" `
              --type app-image `
              --dest $distDir `
              --java-options "-Xmx512m" `
              --java-options "-Dfile.encoding=UTF-8" `
              --java-options "-Dspring.profiles.active=prod" `
              --app-version $version `
              --description "Gestione Fatture - Applicazione Desktop" `
              --vendor "Gestione Fatture" `
              --copyright "2024" `
              --win-console
          
          if ($LASTEXITCODE -ne 0) {
              Write-Host "ERRORE: jpackage fallito con codice $LASTEXITCODE"
              exit 1
          }
          
          # Verifica che l'eseguibile sia stato creato
          $exePath = "$distDir\GestioneFatture\GestioneFatture.exe"
          if (-not (Test-Path $exePath)) {
              Write-Host "ERRORE: Eseguibile non trovato: $exePath"
              exit 1
          }
          
          Write-Host "Eseguibile creato con successo: $exePath"
      
      - name: Create distribution package
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $commitSha = "${{ steps.commit_info.outputs.commit_sha }}"
          $packageName = "GestioneFatture-v$version"
          $appDir = "distribuzione\jpackage-output\GestioneFatture"
          $distDir = "distribuzione\$packageName"
          
          # Verifica che l'applicazione esista
          if (-not (Test-Path $appDir)) {
              Write-Host "ERRORE: Applicazione non trovata: $appDir"
              exit 1
          }
          
          # Crea directory per il pacchetto
          if (Test-Path $distDir) {
              Remove-Item -Path $distDir -Recurse -Force
          }
          New-Item -ItemType Directory -Force -Path $distDir | Out-Null
          
          # Copia l'intera applicazione
          Write-Host "Copia applicazione completa..."
          Copy-Item -Path $appDir\* -Destination $distDir\ -Recurse -Force
          
          # Crea README
          $readmeLines = @(
              "========================================",
              "GESTIONE FATTURE - v$version",
              "========================================",
              "",
              "ISTRUZIONI DI INSTALLAZIONE E USO",
              "",
              "1. INSTALLAZIONE",
              "   - Estrai il contenuto di questo ZIP in una cartella",
              "   - NON √® necessario installare Java (incluso nel pacchetto)",
              "",
              "2. AVVIO RAPIDO",
              "   - Doppio click su `"GestioneFatture.exe`"",
              "   - Il browser si aprir√† automaticamente su http://localhost:8080",
              "   - L'applicazione √® completamente autonoma, non richiede Java installato",
              "",
              "3. STRUTTURA CARTELLE",
              "   - GestioneFatture.exe : Eseguibile principale",
              "   - app/                : Applicazione e risorse",
              "   - runtime/            : Java runtime incluso",
              "   - data/               : Database (creato automaticamente al primo avvio)",
              "   - fatture/            : PDF generati",
              "   - templates/          : Template personalizzati",
              "   - backups/            : Backup database",
              "",
              "4. CONFIGURAZIONE",
              "   - I dati vengono salvati automaticamente nella cartella data/",
              "   - Per personalizzare, modifica i file in app/",
              "",
              "5. BACKUP",
              "   - Per fare backup, copia la cartella `"data/`"",
              "   - Per ripristinare, sostituisci la cartella `"data/`"",
              "",
              "6. PORTABILIT√Ä",
              "   - Puoi copiare l'intera cartella su chiavetta USB",
              "   - Funziona su qualsiasi PC Windows (anche senza Java installato)",
              "   - L'applicazione include tutto il necessario",
              "",
              "========================================",
              "Versione: $version",
              "Commit: $commitSha",
              "========================================"
          )
          $readmeLines | Out-File -FilePath "$distDir\README.txt" -Encoding UTF8
          
          # Crea il pacchetto ZIP
          Write-Host "Creazione pacchetto ZIP..."
          $zipPath = "distribuzione\$packageName.zip"
          if (Test-Path $zipPath) {
              Remove-Item -Path $zipPath -Force
          }
          Compress-Archive -Path "$distDir\*" -DestinationPath $zipPath -Force
          
          Write-Host "Pacchetto creato: $zipPath"
          Write-Host "PACKAGE_PATH=$zipPath" >> $env:GITHUB_ENV
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}-${{ steps.commit_info.outputs.commit_sha }}
          name: Release v${{ steps.get_version.outputs.version }} - ${{ steps.commit_info.outputs.commit_sha }}
          body: |
            ## üöÄ Release Automatica
            
            **Versione**: ${{ steps.get_version.outputs.version }}
            **Commit**: ${{ steps.commit_info.outputs.commit_sha }}
            **Data**: ${{ github.event.head_commit.timestamp }}
            
            ### üìù Modifiche
            ${{ steps.commit_info.outputs.commit_message }}
            
            ### üì¶ Artefatti
            - **Pacchetto di distribuzione completo** (ZIP) - Pronto all'uso, **NON richiede Java installato!**
            - Eseguibile Windows con Java runtime incluso
            - JAR del backend compilato (per utenti avanzati)
            - Frontend compilato e integrato
            - README con istruzioni
            
            ### üöÄ Come usare
            
            **Pacchetto completo (consigliato - NON richiede Java):**
            1. Scarica il file `GestioneFatture-v${{ steps.get_version.outputs.version }}.zip`
            2. Estrai il contenuto in una cartella
            3. Doppio click su `GestioneFatture.exe`
            4. Il browser si aprir√† automaticamente su http://localhost:8080
            5. **NON √® necessario installare Java** - tutto √® incluso nel pacchetto!
            
            **Solo JAR (richiede Java installato):**
            1. Scarica il file `fatture-backend-${{ steps.get_version.outputs.version }}.jar`
            2. Esegui con: `java -jar fatture-backend-${{ steps.get_version.outputs.version }}.jar`
            3. Apri il browser su: http://localhost:8080
            
            ### üìã Requisiti
            - **Pacchetto completo**: Nessun requisito! Funziona su qualsiasi PC Windows
            - **Solo JAR**: Java 17 o superiore (scaricabile da https://adoptium.net/)
          files: |
            distribuzione/GestioneFatture-v*.zip
            backend/target/fatture-backend-*.jar
          draft: false
          prerelease: false

